# checkpoint
source ${SETUP_LOCATION}/checkpoint

mkdir -p ${WORK_DIR}/02-processEimage
cd ${WORK_DIR}/02-processEimage
ln -sfn ${WORK_DIR} pardir
ln -sfn ${DATA_DIR} datadir
processEimage.py ${IN_DIR} --output ${OUT_DIR}
createVisitLists.py --increment ${OUT_DIR}

if [[ $SITE == "LSST-IN2P3" ]]
then
  run_processEimage.py --fromslac -f ${FILTERS} --multicore -m 3
else
  run_processEimage.py --fromnersc --doraise --time -f ${FILTERS} --multicore --clobberversions -m 1
#  run_processEimage.py --fromnersc --doraise --time -f ${FILTERS} --perraft
fi

for FILT in $(echo ${FILTERS} | tr "," "\n")
do
	pipelineSet n${FILT}scripts `ls scripts/${FILT}/*.sh 2>/dev/null | wc -l`
done
pipelineSet WORK_DIR ${WORK_DIR}
pipelineSet FILTERS ${FILTERS}
pipelineSet DM_RELEASE ${DM_RELEASE}
pipelineSet DM_SETUP ${DM_SETUP}
pipelineSet CONFIGS_LOCATION ${CONFIGS_LOCATION}
pipelineSet OUTPUT_DATA_DIR ${OUTPUT_DATA_DIR}
