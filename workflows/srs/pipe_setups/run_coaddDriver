#!/bin/bash

#launch the monitoring script
if [[ $SITE == "LSST-IN2P3" ]]
then
    echo "launching monitoring script..... output will be under $(dirname ${SGE_STDOUT_PATH})"
    /pbs/home/d/descprod/bin/joremon.sh
fi

echo "Working on TRACT=${TRACT}, PATCH=${PATCH}, FILT=${FILT}"

visit_file=${FILEDIR}/${TRACT}_${PATCH}_${FILT}_visits.list 

if [ $FILT = u ]; then
    cd $TMPDIR
    if [[ -z $DIA_REF ]]; then
      cmd="coaddDriver.py ${OUT_DIR} --rerun ${RERUN1}:${RERUN2}-u --id tract=${TRACT} patch=${PATCH} filter=$FILT @${visit_file} --cores $((NSLOTS+1)) --longlog --configfile=${OBS_LSST_DIR}/config/coaddDriver_noPSF.py --reuse-outputs-from  all --doraise"
    else
      cmd="coaddDriver.py ${OUT_DIR} --rerun ${RERUN1}:${RERUN2}-u --id tract=${TRACT} patch=${PATCH} filter=$FILT @${visit_file} --cores $((NSLOTS+1)) --longlog --configfile=${DIA_PIPE_DIR}/config/coaddDriver_BestSeeing_noPSF.py"
    fi
    echo $cmd;$cmd
    if [[ $? == 0 ]]; then
	echo "successful execution of ${cmd}"
    else 
	echo "failure in execution of ${cmd}"
	exit 1
    fi
    for patch in ${PATCH//^/ }; do
	      warpdir="${OUT_DIR}/rerun/${RERUN2}-u/deepCoadd/$FILT/$TRACT/$patch"
	      if [[ -d ${warpdir} && -f ${warpdir}/../$patch.fits ]]; then
    	      echo "removing warps in ${warpdir}"
    	      #rm -r ${warpdir}
	      fi
    done
else
    cd ${TMPDIR}
    if [[ -z $DIA_REF ]]; then
        cmd="coaddDriver.py ${OUT_DIR} --rerun ${RERUN1}:${RERUN2}-grizy --id tract=${TRACT} patch=${PATCH} filter=$FILT @${visit_file} --cores $((NSLOTS+1)) --longlog --reuse-outputs-from  all --doraise"
    else
        cmd="coaddDriver.py ${OUT_DIR} --rerun ${RERUN1}:${RERUN2}-grizy --id tract=${TRACT} patch=${PATCH} filter=$FILT @${visit_file} --cores $((NSLOTS+1)) --longlog --configfile=${DIA_PIPE_DIR}/config/coaddDriver_BestSeeing.py"
    fi
    echo $cmd;$cmd;
    if [[ $? == 0 ]]; then
	echo "successful execution of ${cmd}"
    else 
	echo "failure in execution of ${cmd}"
	exit 1
    fi
    for patch in ${PATCH//^/ }; do
      	warpdir="${OUT_DIR}/rerun/${RERUN2}-grizy/deepCoadd/$FILT/$TRACT/$patch"
        if [[ -d ${warpdir} && -f ${warpdir}/../$patch.fits ]]; then
            echo "removing warps in ${warpdir}"
            #rm -r ${warpdir}
        fi
    done
fi

