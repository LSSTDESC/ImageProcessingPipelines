#!/bin/bash

# checkpoint
source ${SETUP_LOCATION}/checkpoint

#clean input file and copy to TMPDIR
grep "fits.gz" ${VISIT_FILE} > ${TMPDIR}/`basename ${VISIT_FILE}`

#split the resulting files into chunks of limited number of images
split -d -l 500000 ${TMPDIR}/`basename ${VISIT_FILE}` "${TMPDIR}/to_be_ingested_"

echo 'TEST'
ls ${TMPDIR}/to_be_ingested_*

if [[ -z "${INGESTDATA}" ]];
then
  # Ready to ingest
  export OMP_NUM_THREADS=1

  #loop sequentially over the split files
  for f in ${TMPDIR}/to_be_ingested_??;
  do
    if [[ $SITE == "NERSC" ]]
    then
      ingestDriver.py ${IN_DIR} @"$f" --cores 8 --mode link --batch-type none --output ${IN_DIR} -c clobber=True allowError=True register.ignore=True --no-versions
    else
      ingestDriver.py ${IN_DIR} @"$f" --cores 16 -c clobber=True allowError=True register.ignore=True
    fi
  done
fi
